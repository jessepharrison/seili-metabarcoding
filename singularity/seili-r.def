Bootstrap: docker
From: ubuntu:18.04

%labels
Author Jesse Harrison <jesse.harrison@csc.fi>

%post
    
    # set build date
    export BUILD_DATE=2020-11-29

    # Stop installation prompts and unset TMPDIR
    export DEBIAN_FRONTEND=noninteractive
    unset TMPDIR

    # R version
    export R_VERSION=4.0.2

    # Extra variables for MKL installation and linking

    export MKLROOT=/opt/intel/compilers_and_libraries_2020.0.166/linux/mkl
    export PKG_CONFIG_PATH=/opt/intel/compilers_and_libraries_2020.0.166/linux/mkl/bin/pkgconfig:/opt/intel/compilers_and_libraries_2020.0.166/linux/mkl/bin/pkgconfig
    export LD_LIBRARY_PATH=/opt/intel/compilers_and_libraries_2020.0.166/linux/tbb/lib/intel64_lin/gcc4.7:/opt/intel/compilers_and_libraries_2020.0.166/linux/compiler/lib/intel64_lin:/opt/intel/compilers_and_libraries_2020.0.166/linux/mkl/lib/intel64_lin:/opt/intel/compilers_and_libraries_2020.0.166/linux/tbb/lib/intel64_lin/gcc4.7:/opt/intel/compilers_and_libraries_2020.0.166/linux/compiler/lib/intel64_lin:/opt/intel/compilers_and_libraries_2020.0.166/linux/mkl/lib/intel64_lin
    export LIBRARY_PATH=/opt/intel/compilers_and_libraries_2020.0.166/linux/tbb/lib/intel64_lin/gcc4.7:/opt/intel/compilers_and_libraries_2020.0.166/linux/compiler/lib/intel64_lin:/opt/intel/compilers_and_libraries_2020.0.166/linux/mkl/lib/intel64_lin:/opt/intel/compilers_and_libraries_2020.0.166/linux/tbb/lib/intel64_lin/gcc4.7:/opt/intel/compilers_and_libraries_2020.0.166/linux/compiler/lib/intel64_lin:/opt/intel/compilers_and_libraries_2020.0.166/linux/mkl/lib/intel64_lin
    export NLSPATH=/opt/intel/compilers_and_libraries_2020.0.166/linux/mkl/lib/intel64_lin/locale/%l_%t/%N:/opt/intel/compilers_and_libraries_2020.0.166/linux/mkl/lib/intel64_lin/locale/%l_%t/%N
    export CPATH=/opt/intel/compilers_and_libraries_2020.0.166/linux/mkl/include:/opt/intel/compilers_and_libraries_2020.0.166/linux/mkl/include
    export PKG_CONFIG_PATH=/opt/intel/compilers_and_libraries_2020.0.166/linux/mkl/bin/pkgconfig:/opt/intel/compilers_and_libraries_2020.0.166/linux/mkl/bin/pkgconfig

    # MKL installation call

    MKL="-L$MKLROOT/lib/intel64	\
	-Wl,--no-as-needed	\
	-lmkl_gf_lp64		\
  	-lmkl_gnu_thread	\
  	-lmkl_core -lgomp	\
  	-lpthread -lm -ldl"

    # Libraries for R + RStudio basic installation
    apt-get -y update
    apt-get -y install gnupg software-properties-common tzdata \
                       gdebi-core libasound2 libnss3 libegl1-mesa libxkbcommon-x11-0 libgl1-mesa-glx libxtst6 wget

    # Further libraries
    apt-get update
    apt-get -y install libcurl4-openssl-dev libssl-dev libssh2-1-dev libxml2-dev libgsl-dev libhdf5-dev libpq-dev \
 		       xorg libx11-dev libglu1-mesa-dev libfreetype6-dev tk8.6-dev default-jre default-jdk \
                       libudunits2-dev libopenmpi-dev openmpi-bin openmpi-common openmpi-doc openssh-client \
	  	       openssh-server libssh-dev libgmp-dev libmpfr-dev libmagick++-dev libnetcdf-dev \
                       libpoppler-cpp-dev jags libgdal-dev libproj-dev libwxgtk3.0-dev libexpat1-dev wx-common \
                       libogdi3.2-dev unixodbc-dev git dh-autoreconf libfftw3-3 gfortran libreadline-dev \
		       libpcre2-dev

    ## Intel MKL 2020.0.088

    wget https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS-2019.PUB
    apt-key add GPG-PUB-KEY-INTEL-SW-PRODUCTS-2019.PUB
    sh -c 'echo deb https://apt.repos.intel.com/mkl all main > /etc/apt/sources.list.d/intel-mkl.list'

    apt-get -y update
    apt-get -y install intel-mkl-64bit-2020.0-088

    ## R 4.0.2

    wget https://cran.rstudio.com/src/base/R-4/R-${R_VERSION}.tar.gz
    tar -xzvf R-${R_VERSION}.tar.gz
    cd R-${R_VERSION}

    ./configure 		\
  	  --prefix=/usr		\
  	  --with-blas="$MKL"	\
  	  --with-lapack		\
 	  --enable-R-shlib
    make -j4 && make install
    R CMD javareconf
    cd

    # RStudio 1.3.1093

    wget https://download1.rstudio.org/desktop/bionic/amd64/rstudio-1.3.1093-amd64.deb
    gdebi -n rstudio-1.3.1093-amd64.deb

    # Set date-locked MRAN snapshot of CRAN

    if [ -z "$BUILD_DATE" ]; then MRAN=$CRAN; \
    else MRAN=https://mran.microsoft.com/snapshot/${BUILD_DATE}; fi
    echo MRAN=$MRAN >> /etc/environment
    echo "options(repos = c(CRAN='$MRAN'), download.file.method = 'libcurl')" >> /usr/lib/R/etc/Rprofile.site

    # Bioconductor + Bioc packages
    R --slave -e 'if (!requireNamespace("BiocManager",quietly = TRUE)) install.packages("BiocManager")'
    R --slave -e 'BiocManager::install()'
    R --slave -e 'BiocManager::install("phyloseq",ask = FALSE)'
    R --slave -e 'BiocManager::install("microbiome",ask = FALSE)'
    R --slave -e 'BiocManager::install("mixOmics",ask = FALSE)'

    # CRAN packages
    R --slave -e 'install.packages("devtools",repos = "https://cran.rstudio.com/")'
    R --slave -e 'install.packages("tidyverse",repos = "https://cran.rstudio.com/")'
    R --slave -e 'install.packages("vegan",repos = "https://cran.rstudio.com/")'
    R --slave -e 'install.packages("grid",repos = "https://cran.rstudio.com/")'
    R --slave -e 'install.packages("gridExtra",repos = "https://cran.rstudio.com/")'
    R --slave -e 'install.packages("data.table",repos = "https://cran.rstudio.com/")'
    R --slave -e 'install.packages("cowplot",repos = "https://cran.rstudio.com/")'
    R --slave -e 'install.packages("ggfortify",repos = "https://cran.rstudio.com/")'
    R --slave -e 'install.packages("RVAideMemoire",repos = "https://cran.rstudio.com/")'
    R --slave -e 'install.packages("RColorBrewer",repos = "https://cran.rstudio.com/")'
    R --slave -e 'install.packages("Cairo",repos = "https://cran.rstudio.com/")'
    R --slave -e 'install.packages("multcompView",repos = "https://cran.rstudio.com/")'
    R --slave -e 'install.packages("indicspecies",repos = "https://cran.rstudio.com/")'

%environment

    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export TZ=Europe/Helsinki
    export R_LIBS_USER=/usr/lib/R/library

## MKL paths

    export MKLROOT=/opt/intel/compilers_and_libraries_2020.0.166/linux/mkl
    export PKG_CONFIG_PATH=/opt/intel/compilers_and_libraries_2020.0.166/linux/mkl/bin/pkgconfig:/opt/intel/compilers_and_libraries_2020.0.166/linux/mkl/bin/pkgconfig
    export LD_LIBRARY_PATH=/opt/intel/compilers_and_libraries_2020.0.166/linux/tbb/lib/intel64_lin/gcc4.7:/opt/intel/compilers_and_libraries_2020.0.166/linux/compiler/lib/intel64_lin:/opt/intel/compilers_and_libraries_2020.0.166/linux/mkl/lib/intel64_lin:/opt/intel/compilers_and_libraries_2020.0.166/linux/tbb/lib/intel64_lin/gcc4.7:/opt/intel/compilers_and_libraries_2020.0.166/linux/compiler/lib/intel64_lin:/opt/intel/compilers_and_libraries_2020.0.166/linux/mkl/lib/intel64_lin:$LD_LIBRARY_PATH
    export LIBRARY_PATH=/opt/intel/compilers_and_libraries_2020.0.166/linux/tbb/lib/intel64_lin/gcc4.7:/opt/intel/compilers_and_libraries_2020.0.166/linux/compiler/lib/intel64_lin:/opt/intel/compilers_and_libraries_2020.0.166/linux/mkl/lib/intel64_lin:/opt/intel/compilers_and_libraries_2020.0.166/linux/tbb/lib/intel64_lin/gcc4.7:/opt/intel/compilers_and_libraries_2020.0.166/linux/compiler/lib/intel64_lin:/opt/intel/compilers_and_libraries_2020.0.166/linux/mkl/lib/intel64_lin
    export NLSPATH=/opt/intel/compilers_and_libraries_2020.0.166/linux/mkl/lib/intel64_lin/locale/%l_%t/%N:/opt/intel/compilers_and_libraries_2020.0.166/linux/mkl/lib/intel64_lin/locale/%l_%t/%N
    export CPATH=/opt/intel/compilers_and_libraries_2020.0.166/linux/mkl/include:/opt/intel/compilers_and_libraries_2020.0.166/linux/mkl/include
    export PKG_CONFIG_PATH=/opt/intel/compilers_and_libraries_2020.0.166/linux/mkl/bin/pkgconfig:/opt/intel/compilers_and_libraries_2020.0.166/linux/mkl/bin/pkgconfig:$PKG_CONFIG_PATH

